<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RF Automation | Live NOC Monitor</title>
    <style>
        /* --- NOC DARK THEME --- */
        :root {
            --bg-body: #0b0f19;
            --bg-panel: #151e32;
            --bg-input: #0f1525;
            --border: #2a3b55;
            --text-main: #e2e8f0;
            --text-muted: #94a3b8;
            --accent: #3b82f6;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --font-mono: 'Courier New', Courier, monospace;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        body { background-color: var(--bg-body); color: var(--text-main); font-family: system-ui, -apple-system, sans-serif; padding-bottom: 40px; }

        /* --- HEADER --- */
        header {
            background-color: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            position: sticky; top: 0; z-index: 50;
            display: flex; justify-content: space-between; align-items: center;
        }
        .brand { font-weight: bold; font-size: 1.2rem; display: flex; align-items: center; gap: 10px; }
        .brand span { color: var(--accent); }

        /* --- SEARCH BAR --- */
        .search-container { width: 100%; max-width: 600px; position: relative; }
        .search-input {
            width: 100%; padding: 10px 15px 10px 40px;
            background: var(--bg-input); border: 1px solid var(--border);
            border-radius: 6px; color: white; font-size: 0.9rem;
            transition: border 0.2s;
        }
        .search-input:focus { border-color: var(--accent); }
        .search-icon { position: absolute; left: 12px; top: 12px; color: var(--text-muted); }

        /* --- MAIN DASHBOARD --- */
        .container { max-width: 1600px; margin: 0 auto; padding: 20px; }
        
        .stats-row {
            display: flex; gap: 15px; margin-bottom: 20px;
        }
        .stat-card {
            background: var(--bg-panel); border: 1px solid var(--border);
            padding: 15px; border-radius: 6px; flex: 1;
            display: flex; flex-direction: column;
        }
        .stat-label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; }
        .stat-value { font-size: 1.5rem; font-weight: bold; margin-top: 5px; }

        /* --- LINK LIST --- */
        .link-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 15px; }
        
        .link-card {
            background: var(--bg-panel); border: 1px solid var(--border);
            border-radius: 8px; padding: 15px;
            display: flex; flex-direction: column; gap: 10px;
            transition: transform 0.2s, border-color 0.2s;
        }
        .link-card:hover { border-color: var(--text-muted); transform: translateY(-2px); }
        
        .card-header { display: flex; justify-content: space-between; align-items: start; }
        .client-name { font-weight: bold; font-size: 1rem; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--text-muted); }
        .status-up { background: var(--success); box-shadow: 0 0 8px var(--success); }
        .status-down { background: var(--danger); box-shadow: 0 0 8px var(--danger); }

        .card-details { font-size: 0.85rem; color: var(--text-muted); display: flex; flex-direction: column; gap: 4px; }
        .card-ip { font-family: var(--font-mono); color: var(--accent); }

        .btn-diagnose {
            margin-top: 5px; background: var(--accent); color: white; border: none;
            padding: 8px; border-radius: 4px; cursor: pointer; font-weight: 600;
            font-size: 0.85rem; transition: background 0.2s;
        }
        .btn-diagnose:hover { background: #2563eb; }

        /* --- DIAGNOSIS MODAL --- */
        .modal-overlay {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85);
            z-index: 100; align-items: center; justify-content: center;
            backdrop-filter: blur(4px);
        }
        .modal-overlay.open { display: flex; }
        .modal-box {
            background: var(--bg-body); width: 90%; max-width: 700px;
            border: 1px solid var(--border); border-radius: 12px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }
        .modal-header { padding: 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 2rem; }

        /* Logic Steps Visualization */
        .logic-chain { margin-top: 20px; position: relative; padding-left: 20px; border-left: 2px solid var(--border); }
        .step { position: relative; margin-bottom: 25px; padding-left: 15px; }
        .step::before {
            content: ''; position: absolute; left: -26px; top: 0; width: 14px; height: 14px;
            background: var(--bg-body); border: 2px solid var(--text-muted); border-radius: 50%;
            transition: all 0.3s;
        }
        .step.active::before { border-color: var(--accent); background: var(--accent); box-shadow: 0 0 10px var(--accent); }
        .step.success::before { border-color: var(--success); background: var(--success); }
        .step.fail::before { border-color: var(--danger); background: var(--danger); }
        
        .step-title { font-weight: bold; font-size: 0.9rem; margin-bottom: 2px; }
        .step-detail { font-family: var(--font-mono); font-size: 0.8rem; color: var(--text-muted); }

    </style>
</head>
<body>

<!-- Header -->
<header>
    <div class="brand">
        <span>RF</span> AUTOMATION <span style="font-size:0.8rem; color:#64748b;">(LIVE)</span>
    </div>
    <div class="search-container">
        <span class="search-icon">üîç</span>
        <input type="text" id="searchInput" class="search-input" placeholder="Search Client, BTS, POP, or IP Address...">
    </div>
    <div id="system-status" style="font-size:0.8rem; color:var(--success)">‚óè Online</div>
</header>

<!-- Dashboard -->
<div class="container">
    
    <!-- Stats -->
    <div class="stats-row">
        <div class="stat-card">
            <span class="stat-label">Total Inventory</span>
            <span class="stat-value" id="stat-total">0</span>
        </div>
        <div class="stat-card">
            <span class="stat-label">Links Loaded</span>
            <span class="stat-value" id="stat-loaded">0</span>
        </div>
    </div>

    <!-- Results Grid -->
    <div id="results-grid" class="link-grid">
        <!-- Initial Loading State -->
        <div style="grid-column: 1/-1; text-align: center; color: var(--text-muted); padding: 40px;">
            Connecting to Backend...
        </div>
    </div>
</div>

<!-- Diagnosis Modal -->
<div class="modal-overlay" id="modal">
    <div class="modal-box">
        <div class="modal-header">
            <div>
                <h3 id="m-title" style="margin:0;">Diagnosing Link</h3>
                <span id="m-subtitle" style="font-size:0.8rem; color:var(--text-muted);"></span>
            </div>
            <button onclick="closeModal()" style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;">&times;</button>
        </div>
        <div class="modal-body">
            <div style="background:var(--bg-panel); padding:15px; border-radius:6px; margin-bottom:20px; text-align:center;">
                <div style="font-size:0.8rem; color:var(--text-muted);">FINAL STATUS</div>
                <div id="m-final-result" style="font-size:1.2rem; font-weight:bold; margin-top:5px;">Processing...</div>
            </div>

            <div class="logic-chain" id="logic-steps">
                <!-- Steps injected here -->
            </div>
        </div>
    </div>
</div>

<script>
    /**
     * CONFIGURATION
     */
    const API_BASE = 'https://rf-automation-1.onrender.com';
    
    // STATE
    let inventory = []; // Flat list of all 988 links
    let isScanning = false;

    // DOM ELEMENTS
    const els = {
        search: document.getElementById('searchInput'),
        grid: document.getElementById('results-grid'),
        statTotal: document.getElementById('stat-total'),
        statLoaded: document.getElementById('stat-loaded'),
        modal: document.getElementById('modal'),
        mTitle: document.getElementById('m-title'),
        mSubtitle: document.getElementById('m-subtitle'),
        mResult: document.getElementById('m-final-result'),
        steps: document.getElementById('logic-steps')
    };

    /**
     * INITIALIZATION
     */
    document.addEventListener('DOMContentLoaded', async () => {
        await fetchInventory();
        
        // Search Listener
        els.search.addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const filtered = inventory.filter(item => 
                item.Client_Name.toLowerCase().includes(term) ||
                item.POP_Name.toLowerCase().includes(term) ||
                item.BTS_Name.toLowerCase().includes(term) ||
                item.Client_IP.includes(term) ||
                item.Location.toLowerCase().includes(term)
            );
            renderGrid(filtered);
        });
    });

    /**
     * DATA FETCHING
     */
    async function fetchInventory() {
        try {
            const response = await fetch(`${API_BASE}/api/links`);
            if (!response.ok) throw new Error('API Connection Failed');

            const groupedData = await response.json();
            
            // Flatten the grouped data into a single array for easier searching
            inventory = [];
            for (const popName in groupedData) {
                groupedData[popName].forEach(link => {
                    link.POP_Name = popName; // Ensure POP is attached
                    inventory.push(link);
                });
            }

            els.statTotal.innerText = inventory.length;
            els.statLoaded.innerText = inventory.length;
            
            // Show all initially (limit to 50 for performance if needed, but user wants search)
            renderGrid(inventory.slice(0, 100)); 
            
            showToast('Inventory Loaded Successfully', 'success');
        } catch (err) {
            els.grid.innerHTML = `<div style="grid-column:1/-1; text-align:center; color:var(--danger);">Failed to load data. Check backend logs.</div>`;
            console.error(err);
        }
    }

    function renderGrid(links) {
        if (links.length === 0) {
            els.grid.innerHTML = `<div style="grid-column:1/-1; text-align:center; color:var(--text-muted);">No links found.</div>`;
            return;
        }

        els.grid.innerHTML = links.map(link => {
            return `
            <div class="link-card">
                <div class="card-header">
                    <div class="client-name">${link.Client_Name}</div>
                    <div class="status-dot" id="dot-${link.Link_ID}"></div>
                </div>
                <div class="card-details">
                    <div>üìç ${link.Location}</div>
                    <div>üì° BTS: ${link.BTS_Name}</div>
                    <div>üè¢ POP: ${link.POP_Name}</div>
                    <div class="card-ip">${link.Client_IP}</div>
                </div>
                <button class="btn-diagnose" onclick="startDiagnosis('${link.Link_ID}')">‚ö° Run Diagnosis</button>
            </div>
            `;
        }).join('');
    }

    /**
     * SMART DIAGNOSIS ENGINE
     * Logic: Client -> Base -> Gateway -> Peer Context -> Loopback
     */
    async function startDiagnosis(linkId) {
        if (isScanning) {
            alert("A scan is already in progress. Please wait.");
            return;
        }
        isScanning = true;

        const link = inventory.find(l => l.Link_ID === linkId);
        if (!link) return;

        // Open Modal
        els.modal.classList.add('open');
        els.mTitle.innerText = `Link: ${link.Client_Name}`;
        els.mSubtitle.innerText = `POP: ${link.POP_Name} | ID: ${link.Link_ID}`;
        els.mResult.innerText = "Initializing...";
        els.mResult.style.color = "var(--text-main)";
        els.steps.innerHTML = '';

        // Helper to create step UI
        const addStep = (title, detail, status) => {
            const div = document.createElement('div');
            div.className = `step ${status}`;
            div.innerHTML = `<div class="step-title">${title}</div><div class="step-detail">${detail}</div>`;
            els.steps.appendChild(div);
            return div;
        };

        try {
            // --- STEP 1: CLIENT RADIO ---
            let s1 = addStep("1. Client Radio", `Pinging ${link.Client_IP}...`, 'active');
            const clientRes = await pingIP(link.Client_IP);
            
            if (clientRes.alive) {
                s1.className = 'step success';
                els.mResult.innerText = "LINK UP (Stable)";
                els.mResult.style.color = "var(--success)";
                updateDot(linkId, 'up');
                isScanning = false;
                return; // Stop logic
            } else {
                s1.className = 'step fail';
            }

            // --- STEP 2: BASE STATION ---
            let s2 = addStep("2. Base Station", `Pinging ${link.Base_IP}...`, 'active');
            const baseRes = await pingIP(link.Base_IP);
            
            if (baseRes.alive) {
                s2.className = 'step success';
                els.mResult.innerText = "FAULT: Client CPE Down";
                els.mResult.style.color = "var(--danger)";
                updateDot(linkId, 'down');
                isScanning = false;
                return;
            } else {
                s2.className = 'step fail';
            }

            // --- STEP 3: GATEWAY ---
            let s3 = addStep("3. Gateway", `Pinging ${link.Gateway_IP}...`, 'active');
            const gateRes = await pingIP(link.Gateway_IP);
            
            if (gateRes.alive) {
                s3.className = 'step success';
                els.mResult.innerText = "FAULT: Base Sector Down";
                els.mResult.style.color = "var(--danger)";
                updateDot(linkId, 'down');
                isScanning = false;
                return;
            } else {
                s3.className = 'step fail';
            }

            // --- STEP 4: PEER CHECK (CONTEXT) ---
            // If Gateway is down, check if OTHER bases in same POP are reachable.
            let s4 = addStep("4. POP Health Check", "Checking peer Base IPs...", 'active');
            
            // Find 3 other links in same POP
            const peers = inventory.filter(l => l.POP_Name === link.POP_Name && l.Link_ID !== link.Link_ID).slice(0, 3);
            
            if (peers.length > 0) {
                const peerIPs = peers.map(p => p.Base_IP);
                const peerRes = await pingBatch(peerIPs);
                
                // If ANY peer is alive, our gateway is isolated.
                const isPeerUp = Object.values(peerRes).some(r => r.alive);
                
                if (isPeerUp) {
                    s4.querySelector('.step-detail').innerText = "Peers detected UP. Isolated Gateway Failure.";
                    s4.className = 'step fail';
                    els.mResult.innerText = "FAULT: Isolated Gateway Failure";
                    els.mResult.style.color = "var(--danger)";
                    updateDot(linkId, 'down');
                    isScanning = false;
                    return;
                } else {
                    s4.querySelector('.step-detail').innerText = "All peers DOWN. Whole POP affected.";
                    s4.className = 'step fail';
                }
            } else {
                s4.querySelector('.step-detail').innerText = "No peers found in POP.";
                s4.className = 'step fail';
            }

            // --- STEP 5: LOOPBACK ---
            if (link.Loopback_IP && link.Loopback_IP !== 'N/A') {
                let s5 = addStep("5. Core Router (Loopback)", `Pinging ${link.Loopback_IP}...`, 'active');
                const loopRes = await pingIP(link.Loopback_IP);
                
                if (loopRes.alive) {
                    s5.className = 'step success';
                    els.mResult.innerText = "CRITICAL: Router Alive, Backhaul/Fiber Down";
                    els.mResult.style.color = "var(--warning)";
                } else {
                    s5.className = 'step fail';
                    els.mResult.innerText = "CRITICAL: POP Core Router DEAD";
                    els.mResult.style.color = "var(--danger)";
                }
            } else {
                els.mResult.innerText = "CRITICAL: POP Outage (No Loopback)";
                els.mResult.style.color = "var(--danger)";
            }

        } catch (err) {
            addStep("Error", err.message, 'fail');
        } finally {
            isScanning = false;
        }
    }

    /**
     * BACKEND INTEGRATION
     */
    async function pingIP(ip) {
        const res = await pingBatch([ip]);
        return res[ip] || { alive: false, latency: 0 };
    }

    async function pingBatch(ips) {
        try {
            const response = await fetch(`${API_BASE}/api/ping`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ips })
            });
            if (!response.ok) throw new Error('Ping API Error');
            return await response.json();
        } catch (e) {
            console.error(e);
            // Fallback simulation if backend is down (for UI testing)
            const sim = {};
            ips.forEach(ip => { sim[ip] = { alive: false, latency: 0 }; });
            return sim;
        }
    }

    function updateDot(id, status) {
        const dot = document.getElementById(`dot-${id}`);
        if (dot) {
            dot.className = `status-dot status-${status}`;
        }
    }

    function closeModal() {
        els.modal.classList.remove('open');
    }

    // Simple Toast
    function showToast(msg, type='info') {
        const div = document.createElement('div');
        div.style.cssText = `position:fixed; bottom:20px; right:20px; background:var(--bg-panel); color:white; padding:10px 20px; border:1px solid var(--border); border-radius:6px; z-index:999;`;
        div.innerText = msg;
        if(type === 'success') div.style.borderColor = 'var(--success)';
        document.body.appendChild(div);
        setTimeout(() => div.remove(), 3000);
    }
</script>
</body>
</html>
