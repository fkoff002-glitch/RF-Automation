<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NOC Command Center</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --bg-dark: #0f172a; --bg-card: #1e293b; --bg-hover: #334155;
            --primary: #3b82f6; --success: #10b981; --warning: #f59e0b; --danger: #ef4444;
            --text-main: #f8fafc; --text-sub: #94a3b8;
            --border: #1e293b;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { background: var(--bg-dark); color: var(--text-main); font-family: 'Inter', sans-serif; display: flex; height: 100vh; overflow: hidden; }

        /* SIDEBAR */
        .sidebar { width: 260px; background: var(--bg-card); border-right: 1px solid rgba(255,255,255,0.05); padding: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 10; }
        .brand { font-size: 1.2rem; font-weight: 700; color: white; margin-bottom: 30px; display: flex; align-items: center; gap: 10px; }
        .brand span { color: var(--primary); }
        .nav-item { padding: 12px 15px; border-radius: 8px; color: var(--text-sub); cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 12px; font-weight: 500; }
        .nav-item:hover, .nav-item.active { background: var(--bg-hover); color: white; }
        .nav-item i { width: 20px; }

        /* MAIN CONTENT */
        .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .top-bar { height: 70px; border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 30px; background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(10px); }
        .search-container { position: relative; width: 400px; }
        .search-container input { width: 100%; background: var(--bg-dark); border: 1px solid var(--border); color: white; padding: 10px 15px 10px 40px; border-radius: 6px; font-family: 'Inter', sans-serif; outline: none; transition: border 0.2s; }
        .search-container input:focus { border-color: var(--primary); }
        .search-icon { position: absolute; left: 12px; top: 10px; color: var(--text-sub); width: 16px; }

        /* VIEWS */
        .view-section { padding: 30px; overflow-y: auto; height: 100%; display: none; }
        .view-section.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* DASHBOARD GRID */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--bg-card); padding: 20px; border-radius: 10px; border: 1px solid var(--border); }
        .stat-val { font-size: 1.8rem; font-weight: 700; margin-top: 5px; }
        .stat-label { color: var(--text-sub); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px; }

        /* DATA TABLE */
        .data-table-container { background: var(--bg-card); border-radius: 10px; border: 1px solid var(--border); overflow: hidden; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { background: #182235; padding: 15px 20px; text-align: left; color: var(--text-sub); font-weight: 600; font-size: 0.8rem; text-transform: uppercase; }
        td { padding: 15px 20px; border-bottom: 1px solid rgba(255,255,255,0.05); color: var(--text-main); }
        tr:hover td { background: var(--bg-hover); cursor: pointer; }
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 700; background: #334155; color: #cbd5e1; display: inline-block; }
        .ip-font { font-family: 'JetBrains Mono', monospace; color: #94a3b8; }

        /* DETAIL PANEL (SLIDE OVER) */
        .detail-panel { position: absolute; top: 0; right: -600px; width: 600px; height: 100%; background: #111827; border-left: 1px solid var(--border); transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 50; display: flex; flex-direction: column; box-shadow: -10px 0 30px rgba(0,0,0,0.5); }
        .detail-panel.open { right: 0; }
        .panel-header { padding: 25px; border-bottom: 1px solid var(--border); background: var(--bg-card); }
        .panel-body { padding: 25px; overflow-y: auto; flex: 1; }
        
        /* TOPOLOGY MAP */
        .topology { display: flex; align-items: center; justify-content: space-between; margin: 30px 0; position: relative; }
        .topology::before { content: ''; position: absolute; top: 50%; left: 40px; right: 40px; height: 2px; background: #334155; z-index: 0; }
        .node { width: 80px; height: 80px; background: var(--bg-card); border: 2px solid var(--border); border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1; position: relative; transition: all 0.3s; }
        .node i { margin-bottom: 5px; color: var(--text-sub); }
        .node span { font-size: 0.7rem; color: var(--text-sub); font-weight: bold; }
        .node.up { border-color: var(--success); box-shadow: 0 0 15px rgba(16, 185, 129, 0.2); } 
        .node.up i { color: var(--success); }
        .node.down { border-color: var(--danger); box-shadow: 0 0 15px rgba(239, 68, 68, 0.2); }
        .node.down i { color: var(--danger); }

        /* METRIC CARDS */
        .metric-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .metric-box { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.05); }
        .metric-title { font-size: 0.75rem; color: var(--text-sub); margin-bottom: 5px; text-transform: uppercase; }
        .metric-value { font-size: 1.4rem; font-family: 'JetBrains Mono'; font-weight: 600; color: white; }
        .metric-sub { font-size: 0.8rem; margin-top: 4px; }

        /* ACTION BUTTON */
        .btn-action { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1rem; display: flex; align-items: center; justify-content: center; gap: 10px; transition: 0.2s; }
        .btn-action:hover { background: #2563eb; }
        .btn-action:disabled { background: var(--bg-hover); cursor: wait; color: var(--text-sub); }
        
        .spin { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div class="sidebar">
        <div class="brand">
            <i data-lucide="radio-tower"></i> <span>SMART NOC</span>
        </div>
        <div class="nav-item active" onclick="switchView('inventory')"><i data-lucide="layout-grid"></i> Inventory</div>
        <div class="nav-item" onclick="switchView('settings')"><i data-lucide="settings"></i> Settings</div>
    </div>

    <div class="main">
        <div class="top-bar">
            <div class="search-container">
                <i data-lucide="search" class="search-icon"></i>
                <input type="text" id="searchInput" placeholder="Search Client, IP, BTS or Location...">
            </div>
        </div>

        <div id="view-inventory" class="view-section active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Clients</div>
                    <div class="stat-val" id="st-total">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Active POPs</div>
                    <div class="stat-val" id="st-pops">-</div>
                </div>
                <div class="stat-card" style="border-color: var(--success);">
                    <div class="stat-label" style="color:var(--success)">System Status</div>
                    <div class="stat-val" style="font-size:1.2rem; color:var(--success)">ONLINE</div>
                </div>
            </div>

            <div class="data-table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Client Name</th>
                            <th>IP Address</th>
                            <th>Base Station</th>
                            <th>POP / BTS</th>
                            <th>Location</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryTable">
                        <tr><td colspan="6" style="text-align:center; padding:40px; color:#64748b;">Loading Network Data...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="view-settings" class="view-section">
            <h2 style="margin-bottom:20px;">System Settings</h2>
            <div class="metric-box">
                <div class="metric-title">SNMP Configuration</div>
                <div style="margin-top:10px;">Community: <code style="color:var(--primary)">airspan</code></div>
                <div style="margin-top:5px;">Version: v2c</div>
            </div>
        </div>

    </div>

    <div class="detail-panel" id="detailPanel">
        <div class="panel-header">
            <button onclick="closePanel()" style="background:none; border:none; color:#94a3b8; cursor:pointer; float:right;"><i data-lucide="x"></i></button>
            <h2 id="p-name" style="margin-bottom:5px; font-size:1.5rem;">Client Name</h2>
            <div class="ip-font" id="p-ip">10.0.0.0</div>
            <div id="p-location" style="color:var(--text-sub); font-size:0.9rem; margin-top:5px;">Location Info</div>
        </div>
        
        <div class="panel-body">
            <button id="btnDiag" class="btn-action" onclick="runDiagnosis()">
                <i data-lucide="activity"></i> Run Live Diagnostics
            </button>
            
            <div id="diag-results" style="display:none; margin-top:30px;">
                <div style="text-align:center; margin-bottom:20px;">
                    <div id="res-status" style="font-size:1.8rem; font-weight:bold; color:white;">--</div>
                    <div id="res-cause" style="color:#94a3b8; font-size:0.9rem;">--</div>
                </div>

                <div class="topology">
                    <div class="node" id="n-gw"><i data-lucide="server"></i><span>GATEWAY</span></div>
                    <div class="node" id="n-base"><i data-lucide="router"></i><span>BASE</span></div>
                    <div class="node" id="n-client"><i data-lucide="wifi"></i><span>CLIENT</span></div>
                </div>

                <h4 style="color:var(--text-sub); text-transform:uppercase; font-size:0.8rem; margin-bottom:10px; border-bottom:1px solid var(--border); padding-bottom:5px;">Client Telemetry</h4>
                <div class="metric-grid">
                    <div class="metric-box">
                        <div class="metric-title">Signal Strength (RSSI)</div>
                        <div class="metric-value" id="m-rssi">--</div>
                        <div class="metric-sub" id="m-stab">Stability: --</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-title">LAN Negotiation</div>
                        <div class="metric-value" id="m-speed">--</div>
                        <div class="metric-sub">Duplex: Full</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-title">Packet Loss (20 Pkts)</div>
                        <div class="metric-value" id="m-loss">--</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-title">Latency</div>
                        <div class="metric-value" id="m-lat">--</div>
                    </div>
                </div>

                <h4 style="color:var(--text-sub); text-transform:uppercase; font-size:0.8rem; margin-bottom:10px; margin-top:20px; border-bottom:1px solid var(--border); padding-bottom:5px;">Base Station Telemetry</h4>
                <div class="metric-grid">
                     <div class="metric-box">
                        <div class="metric-title">Signal Strength</div>
                        <div class="metric-value" id="b-rssi">--</div>
                        <div class="metric-sub" id="b-stab">Stability: --</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-title">Packet Loss</div>
                        <div class="metric-value" id="b-loss">--</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
    const API_BASE = 'http://192.168.0.104:8000'; // Change to your IP
    let allData = [];
    let currentClient = null;

    // ICONS
    lucide.createIcons();

    // INIT
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            const res = await fetch(`${API_BASE}/api/inventory`);
            const json = await res.json();
            allData = json.data;
            document.getElementById('st-total').innerText = json.stats.total;
            document.getElementById('st-pops').innerText = json.stats.pops;
            renderTable(allData);
        } catch(e) {
            document.getElementById('inventoryTable').innerHTML = `<tr><td colspan="6" style="color:var(--danger); text-align:center;">Failed to connect to Backend</td></tr>`;
        }
    });

    // SEARCH
    document.getElementById('searchInput').addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase();
        const filtered = allData.filter(c => 
            c.Client_Name.toLowerCase().includes(term) || 
            c.Client_IP.includes(term) || 
            c.POP_Name.toLowerCase().includes(term)
        );
        renderTable(filtered);
    });

    function renderTable(data) {
        const tbody = document.getElementById('inventoryTable');
        if(data.length === 0) { tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;">No results found</td></tr>`; return; }
        
        tbody.innerHTML = data.map(c => `
            <tr onclick='openDetail(${JSON.stringify(c)})'>
                <td style="font-weight:600; color:white;">${c.Client_Name}</td>
                <td class="ip-font">${c.Client_IP}</td>
                <td class="ip-font">${c.Base_IP}</td>
                <td>${c.POP_Name}</td>
                <td>${c.Location}</td>
                <td><span class="status-badge">View</span></td>
            </tr>
        `).join('');
    }

    // PANEL LOGIC
    function openDetail(client) {
        currentClient = client;
        document.getElementById('p-name').innerText = client.Client_Name;
        document.getElementById('p-ip').innerText = client.Client_IP;
        document.getElementById('p-location').innerText = `${client.Location} â€¢ ${client.POP_Name}`;
        
        // Reset View
        document.getElementById('diag-results').style.display = 'none';
        document.getElementById('btnDiag').innerHTML = `<i data-lucide="activity"></i> Run Live Diagnostics`;
        document.getElementById('btnDiag').disabled = false;
        
        document.getElementById('detailPanel').classList.add('open');
        lucide.createIcons();
    }

    function closePanel() {
        document.getElementById('detailPanel').classList.remove('open');
    }

    // DIAGNOSIS LOGIC
    async function runDiagnosis() {
        if(!currentClient) return;
        const btn = document.getElementById('btnDiag');
        btn.disabled = true;
        btn.innerHTML = `<i data-lucide="loader-2" class="spin"></i> Analyzing Network (20 Pkts)...`;

        try {
            const res = await fetch(`${API_BASE}/api/diagnose`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ name: currentClient.Client_Name, ip: currentClient.Client_IP })
            });
            const data = await res.json();
            
            // Show Results
            document.getElementById('diag-results').style.display = 'block';
            
            // 1. Status Header
            const final = document.getElementById('res-status');
            final.innerText = data.final_status;
            final.style.color = data.final_status.includes("UP") || data.final_status.includes("Stable") ? "var(--success)" : 
                                (data.final_status.includes("UNSTABLE") ? "var(--warning)" : "var(--danger)");
            document.getElementById('res-cause').innerText = data.cause;

            // 2. Topology Visualizer
            const cNode = document.getElementById('n-client');
            const bNode = document.getElementById('n-base');
            const gNode = document.getElementById('n-gw');
            
            // Reset
            [cNode, bNode, gNode].forEach(n => { n.className = 'node'; });

            if(data.topology.client.status === "UP") cNode.classList.add('up'); else cNode.classList.add('down');
            if(data.topology.base.status === "UP") bNode.classList.add('up'); else bNode.classList.add('down');
            if(data.topology.gw.status === "UP") gNode.classList.add('up'); else gNode.classList.add('down');

            // 3. Client Telemetry
            const cData = data.topology.client.data;
            document.getElementById('m-rssi').innerText = cData.rssi || '--';
            document.getElementById('m-rssi').style.color = (cData.rssi && parseInt(cData.rssi) > -65) ? "var(--success)" : "white";
            document.getElementById('m-stab').innerText = cData.stability || '--';
            document.getElementById('m-speed').innerText = cData.lan_speed || '--';
            document.getElementById('m-loss').innerText = data.topology.client.loss;
            document.getElementById('m-lat').innerText = data.topology.client.latency;

            // 4. Base Telemetry
            const bData = data.topology.base.data;
            document.getElementById('b-rssi').innerText = bData.rssi || 'N/A';
            document.getElementById('b-stab').innerText = bData.stability || '--';
            document.getElementById('b-loss').innerText = data.topology.base.loss;

        } catch(e) {
            alert("Connection Failed");
        } finally {
            btn.innerHTML = `<i data-lucide="check"></i> Diagnosis Complete`;
            lucide.createIcons();
        }
    }

    function switchView(viewName) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById(`view-${viewName}`).classList.add('active');
    }
</script>
</body>
</html>
