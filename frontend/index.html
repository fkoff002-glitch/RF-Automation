<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RF Automation | Radio Link Monitor</title>
    <style>
        :root {
            --bg: #0f172a;
            --card: #1e293b;
            --border: #334155;
            --text: #f8fafc;
            --sub: #94a3b8;
            --primary: #3b82f6;
            --success: #22c55e;
            --warning: #eab308;
            --danger: #ef4444;
            --crit: #7f1d1d;
        }
        body { margin: 0; font-family: 'Inter', system-ui, sans-serif; background: var(--bg); color: var(--text); }
        
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid var(--border); }
        
        .header-btn {
            background: var(--success); border: none; padding: 10px 20px; 
            color: white; border-radius: 4px; cursor: pointer; font-weight: bold;
        }
        .header-btn:hover { background: #16a34a; }

        .pop-group { margin-bottom: 30px; }
        
        .pop-title { 
            background: var(--card); padding: 10px 20px; border-radius: 6px 6px 0 0; 
            font-weight: bold; display: inline-block; border: 1px solid var(--border); border-bottom: none;
        }

        /* Table Styles */
        table { width: 100%; border-collapse: collapse; background: var(--card); }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border); }
        th { background: #334155; color: var(--sub); font-size: 0.85rem; text-transform: uppercase; }
        tr:hover { background: rgba(255,255,255,255,0.05); }

        /* Status Badges */
        .status-badge { padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: bold; }
        .bg-green { background: rgba(34, 197, 94, 0.2); color: var(--success); }
        .bg-orange { background: rgba(234, 179, 8, 0.2); color: var(--warning); }
        .bg-red { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
        .bg-darkred { background: rgba(127, 29, 29, 0.5); color: #fca5a5; }

        /* Expandable Hop Logic Visualizer */
        .hop-row { display: none; background: #111; font-family: monospace; font-size: 0.8rem; }
        .hop-row.visible { display: table-row; }
        
        .hop-step { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; }
        .step-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--border); }
        .step-dot.alive { background: var(--success); box-shadow: 0 0 5px var(--success); }
        .step-dot.dead { background: var(--danger); }
        
        .loading { text-align: center; padding: 50px; color: var(--sub); font-size: 1.2rem; }
        
        .error-box {
            background: var(--card); padding: 30px; border-radius: 8px; text-align: center; 
            border: 1px solid var(--danger); max-width: 500px; margin: 50px auto;
        }
        .btn-path { font-size: 0.7rem; padding: 4px 8px; border: 1px solid var(--border); background: transparent; color: var(--text); cursor: pointer; border-radius: 4px; }
        .btn-path:hover { border-color: var(--primary); color: var(--primary); }

        @media (max-width: 768px) {
            .pop-group, table, .pop-title { grid-template-columns: 1fr; gap: 0.5rem; }
            th, td { padding: 8px; font-size: 0.85rem; }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div>
            <h1 style="margin:0;">RF Automation</h1>
            <span style="color:var(--sub); margin-left: 10px;">Radio Link Health Monitor</span>
        </div>
        <button class="header-btn" onclick="fetchData()">Refresh Status</button>
    </header>

    <div id="app">
        <div class="loading">
            <div>üîç Fetching Radio Links...</div>
        </div>
    </div>
</div>

<script>
    // Auto-detect API URL based on current location
    const getApiUrl = () => {
        const currentHost = window.location.hostname;
        
        // 1. Local Development
        if (currentHost === 'localhost' || currentHost === '127.0.0.1') {
            return 'http://localhost:3000/api/links';
        }
        
        // 2. Production (Render Backend)
        // If it's not localhost, assume we need the specific Render URL
        return 'https://rf-automation-1.onrender.com/api/links';
    };

    const API_URL = getApiUrl();
    console.log('API URL:', API_URL);

    async function fetchData() {
        const app = document.getElementById('app');
        app.innerHTML = `
            <div class="loading">
                <div>üîç Fetching Radio Links...</div>
                <small>Connecting to: ${API_URL}</small>
            </div>
        `;

        try {
            const response = await fetch(API_URL);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log('Data received:', Object.keys(data).length, 'POP groups');
            renderUI(data);
            
        } catch (error) {
            console.error('Fetch error:', error);
            app.innerHTML = `
                <div class="error-box">
                    <h3 style="color: var(--danger);">‚ö†Ô∏è Connection Error</h3>
                    <p style="color: var(--sub);">${error.message}</p>
                    <p style="color: var(--sub); font-size: 0.9rem; margin-top: 20px;">
                        Backend URL: ${API_URL}<br>
                        Make sure the backend server is running.
                    </p>
                    <button onclick="fetchData()" class="header-btn" style="margin-top: 20px;">üîÑ Retry</button>
                </div>
            `;
        }
    }

    function renderUI(groupedData) {
        const app = document.getElementById('app');
        app.innerHTML = '';

        // Loop through each POP
        for (const [popName, links] of Object.entries(groupedData)) {
            
            // Create POP Container
            const section = document.createElement('div');
            section.className = 'pop-group';
            
            const title = document.createElement('div');
            title.className = 'pop-title';
            title.innerText = `${popName} (${links.length} Links)`;
            section.appendChild(title);

            // Create Table
            const table = document.createElement('table');
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Client Name</th>
                        <th>Link ID</th>
                        <th>Status (Auto-Diag)</th>
                        <th>Latency</th>
                        <th>Path Visualization</th>
                    </tr>
                </thead>
                <tbody></tbody>
            `;
            const tbody = table.querySelector('tbody');

            // Populate Links
            links.forEach(link => {
                const d = link.diagnosis;
                
                // Main Row
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${link.Client_Name} <br><small style="color:var(--sub)">${link.Client_IP}</small></td>
                    <td><span style="font-family:monospace">${link.Link_ID}</span></td>
                    <td><span class="status-badge bg-${d.color === 'green' ? 'green' : d.color === 'orange' ? 'orange' : 'red'}">${d.status}</span> <br><small>${d.message}</small></td>
                    <td>${d.latency ? d.latency + 'ms' : '-'}</td>
                    <td><button class="btn-path" onclick="toggleHops('${link.Link_ID}')">View Path</button></td>
                `;

                // Expandable Row (Ping Path Visualizer)
                const trExpand = document.createElement('tr');
                trExpand.id = `hop-${link.Link_ID}`;
                trExpand.className = 'hop-row';
                
                // Determine failure point to highlight in red
                const failedHop = d.failedHop || 'None';
                
                // Build Steps
                const steps = [
                    { name: 'Client', ip: link.Client_IP, alive: d.status === 'UP' },
                    { name: 'Base', ip: link.Base_IP, alive: d.color !== 'red' && d.color !== 'darkred' },
                    { name: 'Gateway', ip: link.Gateway_IP, alive: d.color !== 'darkred' },
                    { name: 'Loopback', ip: link.Loopback_IP, alive: true }
                ];

                let hopHtml = '<td colspan="5" style="padding: 15px;"><div style="display:flex; gap:20px; flex-wrap:wrap;">';
                
                steps.forEach((step, index) => {
                    const isLast = index === steps.length - 1;
                    hopHtml += `
                        <div class="hop-step">
                            <div style="font-size:0.7rem; color:var(--sub);">Step ${index+1}</div>
                            <div class="step-dot ${step.alive ? 'alive' : 'dead'}"></div>
                            <div>
                                <strong>${step.name}</strong><br>
                                <span style="color:var(--sub)">${step.ip}</span><br>
                                <span style="color:${step.alive ? 'var(--success)' : 'var(--danger)'}">
                                    ${step.alive ? 'ALIVE' : 'NO RESPONSE'}
                                </span>
                            </div>
                            ${!isLast ? '‚ûú' : ''}
                        </div>
                    `;
                });

                hopHtml += '</div></td>';
                trExpand.innerHTML = hopHtml;

                tbody.appendChild(tr);
                tbody.appendChild(trExpand);
            });

            section.appendChild(table);
            app.appendChild(section);
        }
    }

    function toggleHops(linkId) {
        const row = document.getElementById(`hop-${linkId}`);
        if (row.classList.contains('visible')) {
            row.classList.remove('visible');
        } else {
            row.classList.add('visible');
        }
    }

    // Load on start and auto-refresh
    fetchData();
    setInterval(fetchData, 60000); // Auto refresh every 60s
</script>

</body>
</html>
