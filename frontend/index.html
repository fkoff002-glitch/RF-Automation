<script>
    const API_URL = window.location.hostname === 'localhost' ? 'http://localhost:3000/api' : 'https://rf-automation-1.onrender.com/api';
    let fullData = {};

    // 1. LOAD INVENTORY
    async function loadInventory() {
        const app = document.getElementById('app');
        app.innerHTML = '<div class="loading">üìÑ Fetching Client List...</div>';
        
        try {
            const res = await fetch(`${API_URL}/links`);
            if (!res.ok) throw new Error('Backend Connection Failed');
            fullData = await res.json();
            renderUI(fullData);
        } catch (err) {
            app.innerHTML = `<div style="color:var(--danger); text-align:center; padding:50px;">
                <h3>‚ö†Ô∏è Error Loading Data</h3>
                <p>${err.message}</p>
                <button class="btn btn-blue" onclick="loadInventory()">Retry</button>
            </div>`;
        }
    }

    // 2. RENDER UI
    function renderUI(data) {
        const app = document.getElementById('app');
        app.innerHTML = '';
        const filter = document.getElementById('searchInput').value.toLowerCase();

        for (const [popName, links] of Object.entries(data)) {
            // Filter Logic
            const visibleLinks = links.filter(l => 
                l.Client_Name.toLowerCase().includes(filter) || 
                l.Client_IP.includes(filter) || 
                popName.toLowerCase().includes(filter)
            );

            if (visibleLinks.length === 0) continue;

            // Create POP Container
            const section = document.createElement('div');
            section.className = 'pop-group';
            section.innerHTML = `
                <div class="pop-header">
                    <strong>${popName} (${visibleLinks.length})</strong>
                    <button class="btn btn-scan" onclick="scanPOP('${popName}')">‚ö° Scan This POP</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th style="width:30%">Client Name</th>
                            <th>IP Address</th>
                            <th>Status</th>
                            <th>Latency</th>
                            <th>Path</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-${popName.replace(/\s/g, '_')}"></tbody>
                </table>
            `;

            const tbody = section.querySelector('tbody');
            
            visibleLinks.forEach(link => {
                const safeIP = link.Client_IP.replace(/\./g, '-');
                const rowId = `row-${safeIP}`;
                
                // Determine Status Color
                let badgeClass = 'bg-gray';
                if(link.diagnosis.status === 'UP') badgeClass = 'bg-green';
                if(link.diagnosis.status === 'DOWN') badgeClass = 'bg-red';

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <div style="font-weight:bold">${link.Client_Name}</div>
                        <div style="font-size:0.8rem; color:#64748b">${link.Link_ID}</div>
                    </td>
                    <td style="font-family:monospace">${link.Client_IP}</td>
                    <td id="status-${safeIP}">
                        <span class="status-dot ${badgeClass}"></span> ${link.diagnosis.status}
                    </td>
                    <td id="lat-${safeIP}" style="font-family:monospace">${link.diagnosis.latency || '-'}</td>
                    <td>
                        <button class="btn btn-blue" style="padding:4px 8px; font-size:0.7rem;" onclick="togglePath('${rowId}')">View Path</button>
                    </td>
                `;

                // Path Visualization Row
                const pathTr = document.createElement('tr');
                pathTr.id = `path-${rowId}`;
                pathTr.style.display = 'none';
                pathTr.innerHTML = `
                    <td colspan="5" style="background:#0f172a; padding:20px;">
                        <div style="display:flex; gap:20px; align-items:center;">
                            ${renderPathStep('Client', link.Client_IP, link.diagnosis.status)}
                            <span style="color:#64748b">‚ûú</span>
                            ${renderPathStep('Base', link.Base_IP, link.diagnosis.status)}
                            <span style="color:#64748b">‚ûú</span>
                            ${renderPathStep('Gateway', link.Gateway_IP, link.diagnosis.status)}
                            <span style="color:#64748b">‚ûú</span>
                            ${renderPathStep('Loopback', link.Loopback_IP, link.diagnosis.status)}
                        </div>
                    </td>
                `;

                tbody.appendChild(tr);
                tbody.appendChild(pathTr);
            });

            app.appendChild(section);
        }
    }

    // Helper: Logic for Dot Colors
    function renderPathStep(label, ip, status) {
        if (!ip || ip === 'N/A') return ''; // Skip empty steps

        let dotClass = 'bg-gray'; // Default (Pending)
        let text = 'WAITING';

        if (status === 'UP') {
            dotClass = 'bg-green';
            text = 'ALIVE';
        } else if (status === 'DOWN' || status === 'CRITICAL') {
            // Simple logic: If scanning failed, assume Client is the issue mostly
            // You can make this smarter if the backend provides per-hop status
            dotClass = (label === 'Client') ? 'bg-red' : 'bg-green'; 
            text = (label === 'Client') ? 'NO RESPONSE' : 'ALIVE?';
        }

        return `
            <div style="display:flex; align-items:center; gap:8px;">
                <div class="status-dot ${dotClass}"></div>
                <div>
                    <div style="font-size:0.75rem; font-weight:bold; color:#cbd5e1">${label}</div>
                    <div style="font-size:0.7rem; color:#64748b; font-family:monospace">${ip}</div>
                </div>
            </div>
        `;
    }

    function togglePath(rowId) {
        const row = document.getElementById(`path-${rowId}`);
        row.style.display = row.style.display === 'none' ? 'table-row' : 'none';
    }

    // 3. SCAN LOGIC
    async function scanPOP(popName) {
        const cleanPop = popName.replace(/\s/g, '_');
        const tbody = document.getElementById(`tbody-${cleanPop}`);
        
        // Find IPs in this table
        const ipsToPing = [];
        const rows = tbody.querySelectorAll('td[id^="status-"]');
        
        rows.forEach(td => {
            const safeIP = td.id.replace('status-', '');
            const ip = safeIP.replace(/-/g, '.');
            ipsToPing.push(ip);
            
            // Set UI to Scanning
            td.innerHTML = '<span class="status-dot bg-gray" style="animation:pulse 1s infinite"></span> Scanning...';
        });

        try {
            const res = await fetch(`${API_URL}/ping`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ targetIPs: ipsToPing })
            });
            const results = await res.json();

            // Update UI
            Object.keys(results).forEach(ip => {
                const safeIP = ip.replace(/\./g, '-');
                const data = results[ip];
                
                const statusCell = document.getElementById(`status-${safeIP}`);
                const latCell = document.getElementById(`lat-${safeIP}`);
                const rowId = `row-${safeIP}`;
                
                // Update Badge
                if (data.alive) {
                    statusCell.innerHTML = `<span class="status-dot bg-green"></span> UP`;
                    latCell.innerText = data.latency + 'ms';
                    latCell.style.color = 'var(--success)';
                    // Update Path Visualizer (Hidden Row)
                    updatePathVisuals(rowId, 'UP');
                } else {
                    statusCell.innerHTML = `<span class="status-dot bg-red"></span> DOWN`;
                    latCell.innerText = '-';
                    latCell.style.color = 'var(--danger)';
                    updatePathVisuals(rowId, 'DOWN');
                }
            });

        } catch (err) {
            console.error(err);
            alert('Scan failed. Check console.');
        }
    }

    // Helper to update the hidden path row after scan
    function updatePathVisuals(rowId, status) {
        const pathRow = document.getElementById(`path-${rowId}`);
        if(!pathRow) return;
        
        // Simple update: Refresh the HTML with new status
        // Extract IPs from existing HTML (or store them in data attributes optimally)
        // For now, we just change the dot colors via class replacement for simplicity
        const dots = pathRow.querySelectorAll('.status-dot');
        dots.forEach(dot => {
            dot.className = `status-dot ${status === 'UP' ? 'bg-green' : 'bg-red'}`;
        });
    }

    // Initial Load
    loadInventory();
</script>
