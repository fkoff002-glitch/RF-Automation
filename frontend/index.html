<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RF Monitor | Live Check</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --border: #334155; --text: #f8fafc; --primary: #3b82f6; --success: #22c55e; --danger: #ef4444; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        
        /* HEADER */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 20px; }
        .search-box { background: var(--card); border: 1px solid var(--border); color: white; padding: 10px; width: 300px; border-radius: 6px; }
        
        /* BUTTONS */
        .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; color: white; transition: 0.2s; }
        .btn-blue { background: var(--primary); }
        .btn-blue:hover { background: #2563eb; }
        .btn-scan { background: var(--success); font-size: 0.8rem; }
        
        /* TABLE */
        .pop-group { margin-bottom: 30px; background: var(--card); border-radius: 8px; border: 1px solid var(--border); overflow: hidden; }
        .pop-header { padding: 15px; background: #334155; display: flex; justify-content: space-between; align-items: center; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border); }
        th { background: rgba(0,0,0,0.2); color: #94a3b8; font-size: 0.85rem; }
        
        /* STATUS */
        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .bg-gray { background: #64748b; box-shadow: none; }
        .bg-green { background: var(--success); box-shadow: 0 0 8px var(--success); }
        .bg-red { background: var(--danger); box-shadow: 0 0 8px var(--danger); }
        
        .console-output { font-family: monospace; font-size: 0.8rem; color: #a5b4fc; margin-top: 4px; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>ðŸ“¡ RF Monitor <span style="font-size:0.5em; color:#94a3b8; font-weight:normal">On-Demand System</span></h1>
        <div style="display:flex; gap:10px;">
            <input type="text" id="searchInput" class="search-box" placeholder="Search Client, IP, or POP..." onkeyup="filterUI()">
            <button class="btn btn-blue" onclick="loadInventory()">â†» Reload List</button>
        </div>
    </header>

    <div id="app">Loading...</div>
</div>

<script>
    const API_URL = window.location.hostname === 'localhost' ? 'http://localhost:3000/api' : 'https://rf-automation-1.onrender.com/api';
    let fullData = {};

    // 1. LOAD INVENTORY (No Ping)
    async function loadInventory() {
        document.getElementById('app').innerHTML = '<div style="text-align:center; padding:50px;">ðŸ“„ Fetching Client List...</div>';
        try {
            const res = await fetch(`${API_URL}/links`);
            fullData = await res.json();
            renderUI(fullData);
        } catch (err) {
            document.getElementById('app').innerHTML = `<div style="color:red; text-align:center;">Error: ${err.message}</div>`;
        }
    }

    // 2. RENDER UI
    function renderUI(data) {
        const app = document.getElementById('app');
        app.innerHTML = '';
        const filter = document.getElementById('searchInput').value.toLowerCase();

        for (const [popName, links] of Object.entries(data)) {
            // Filter logic
            const visibleLinks = links.filter(l => 
                l.Client_Name.toLowerCase().includes(filter) || 
                l.Client_IP.includes(filter) || 
                popName.toLowerCase().includes(filter)
            );

            if (visibleLinks.length === 0) continue;

            const section = document.createElement('div');
            section.className = 'pop-group';
            section.innerHTML = `
                <div class="pop-header">
                    <strong>${popName} (${visibleLinks.length})</strong>
                    <button class="btn btn-scan" onclick="scanPOP('${popName}')">âš¡ Scan This POP</button>
                </div>
                <table>
                    <thead><tr><th>Client</th><th>IP Address</th><th>Status</th><th>Latency</th></tr></thead>
                    <tbody id="tbody-${popName.replace(/\s/g, '_')}"></tbody>
                </table>
            `;

            const tbody = section.querySelector('tbody');
            visibleLinks.forEach(link => {
                const tr = document.createElement('tr');
                tr.id = `row-${link.Client_IP.replace(/\./g, '-')}`;
                tr.innerHTML = `
                    <td>${link.Client_Name}<br><small style="color:#64748b">${link.Location}</small></td>
                    <td style="font-family:monospace">${link.Client_IP}</td>
                    <td id="status-${link.Client_IP.replace(/\./g, '-')}" class="status-cell">
                        <span class="status-dot bg-gray"></span> Idle
                    </td>
                    <td id="lat-${link.Client_IP.replace(/\./g, '-')}" style="font-family:monospace">-</td>
                `;
                tbody.appendChild(tr);
            });
            app.appendChild(section);
        }
    }

    // 3. SCAN LOGIC (Triggered by Button)
    async function scanPOP(popName) {
        const cleanPop = popName.replace(/\s/g, '_');
        const tbody = document.getElementById(`tbody-${cleanPop}`);
        const rows = tbody.querySelectorAll('tr');
        
        // Gather IPs to ping
        const ipsToPing = [];
        rows.forEach(row => {
            // Extract IP from the row ID we set earlier
            const ip = row.id.replace('row-', '').replace(/-/g, '.');
            ipsToPing.push(ip);
            
            // Set UI to "Scanning"
            document.getElementById(`status-${row.id.replace('row-', '')}`).innerHTML = 
                '<span class="status-dot bg-gray" style="animation: pulse 1s infinite"></span> Pinging...';
        });

        try {
            // Send to Backend
            const res = await fetch(`${API_URL}/ping`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ targetIPs: ipsToPing })
            });
            const results = await res.json();

            // Update UI with Results
            Object.keys(results).forEach(ip => {
                const safeIP = ip.replace(/\./g, '-');
                const data = results[ip];
                const statusCell = document.getElementById(`status-${safeIP}`);
                const latCell = document.getElementById(`lat-${safeIP}`);
                
                if (statusCell) {
                    if (data.alive) {
                        statusCell.innerHTML = `<span class="status-dot bg-green"></span> Reply from ${ip}`;
                        latCell.innerText = `${data.latency}ms`;
                        latCell.style.color = 'var(--success)';
                    } else {
                        statusCell.innerHTML = `<span class="status-dot bg-red"></span> Request Timed Out`;
                        latCell.innerText = 'timeout';
                        latCell.style.color = 'var(--danger)';
                    }
                }
            });

        } catch (err) {
            console.error(err);
            alert('Scan failed. Check console.');
        }
    }

    function filterUI() { renderUI(fullData); }

    // Initial Load
    loadInventory();
</script>

<style>
@keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
</style>
</body>
</html>
