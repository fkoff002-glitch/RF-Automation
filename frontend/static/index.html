<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NOC Command Center</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --bg-dark: #09090b;
            --glass: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.08);
            --primary: #6366f1; /* Indigo */
            --accent: #8b5cf6;  /* Violet */
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { background: var(--bg-dark); color: var(--text-main); font-family: 'Outfit', sans-serif; display: flex; height: 100vh; overflow: hidden; }

        /* --- SIDEBAR --- */
        .sidebar { width: 280px; background: rgba(0,0,0,0.4); border-right: 1px solid var(--glass-border); padding: 25px; display: flex; flex-direction: column; backdrop-filter: blur(10px); z-index: 20; }
        .logo { font-size: 1.4rem; font-weight: 700; background: linear-gradient(45deg, var(--primary), var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 40px; display: flex; align-items: center; gap: 10px; }
        
        .nav-item { padding: 14px 18px; border-radius: 12px; color: var(--text-muted); cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 12px; font-weight: 500; border: 1px solid transparent; }
        .nav-item:hover { background: var(--glass); color: white; border-color: var(--glass-border); }
        .nav-item.active { background: linear-gradient(90deg, rgba(99, 102, 241, 0.1), transparent); color: var(--primary); border-left: 3px solid var(--primary); }

        /* --- MAIN AREA --- */
        .main-content { flex: 1; position: relative; overflow-y: auto; background: radial-gradient(circle at 10% 20%, rgba(99, 102, 241, 0.05) 0%, transparent 40%); padding: 40px; }
        
        /* HEADER & CONTROLS */
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .search-bar { width: 400px; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); color: white; padding: 12px 20px; border-radius: 12px; font-size: 0.95rem; outline: none; transition: border 0.2s; }
        .search-bar:focus { border-color: var(--primary); }

        .btn-import { background: var(--glass); border: 1px solid var(--glass-border); color: var(--text-muted); padding: 10px 20px; border-radius: 10px; cursor: pointer; font-size: 0.9rem; transition: 0.3s; display: flex; align-items: center; gap: 8px; }
        .btn-import:hover { background: rgba(255,255,255,0.05); color: white; border-color: var(--primary); }

        /* --- DATA TABLES --- */
        .table-container { background: var(--glass); border-radius: 16px; border: 1px solid var(--glass-border); overflow: hidden; backdrop-filter: blur(10px); }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 18px 25px; color: var(--text-muted); font-weight: 600; font-size: 0.85rem; text-transform: uppercase; border-bottom: 1px solid var(--glass-border); }
        td { padding: 18px 25px; border-bottom: 1px solid rgba(255,255,255,0.02); color: var(--text-main); font-size: 0.95rem; }
        tr:hover td { background: rgba(255,255,255,0.02); cursor: pointer; }
        .tag { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; display: inline-block; background: rgba(99, 102, 241, 0.15); color: var(--primary); }

        /* --- SLIDE PANEL --- */
        .slide-panel { position: fixed; top: 0; right: -650px; width: 650px; height: 100%; background: #0c0c0e; border-left: 1px solid var(--glass-border); z-index: 100; transition: right 0.4s cubic-bezier(0.16, 1, 0.3, 1); box-shadow: -20px 0 50px rgba(0,0,0,0.5); display: flex; flex-direction: column; }
        .slide-panel.open { right: 0; }
        .panel-header { padding: 30px; border-bottom: 1px solid var(--glass-border); background: rgba(255,255,255,0.01); }
        .panel-body { padding: 30px; overflow-y: auto; flex: 1; }

        /* DIAGNOSTICS UI */
        .topology-map { display: flex; align-items: center; justify-content: space-between; margin: 40px 0; position: relative; padding: 0 20px; }
        .topology-line { position: absolute; top: 50%; left: 60px; right: 60px; height: 2px; background: #333; z-index: 0; }
        .node { width: 90px; height: 90px; background: #18181b; border: 2px solid #333; border-radius: 16px; z-index: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: 0.3s; }
        .node i { margin-bottom: 5px; color: #555; }
        .node span { font-size: 0.7rem; font-weight: 700; color: #777; margin-top: 5px; }
        .node.up { border-color: var(--success); box-shadow: 0 0 20px rgba(16, 185, 129, 0.15); } .node.up i { color: var(--success); }
        .node.down { border-color: var(--danger); box-shadow: 0 0 20px rgba(239, 68, 68, 0.15); } .node.down i { color: var(--danger); }
        .node.warn { border-color: var(--warning); box-shadow: 0 0 20px rgba(245, 158, 11, 0.15); } .node.warn i { color: var(--warning); }

        .metric-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .metric-box { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05); }
        .metric-val { font-family: 'JetBrains Mono'; font-size: 1.5rem; font-weight: 600; margin: 5px 0; color: white; }
        .metric-lbl { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; }

        .btn-main { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 12px; font-size: 1rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: 0.2s; box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3); }
        .btn-main:hover { background: #4f46e5; transform: translateY(-2px); }
        .spin { animation: spin 1s linear infinite; } @keyframes spin { to { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div class="sidebar">
        <div class="logo">
            <i data-lucide="radio-tower"></i>
            <span>SMART NOC</span>
        </div>
        <div class="nav-item active"><i data-lucide="layout-grid"></i> Dashboard</div>
    </div>

    <div class="main-content">
        
        <div class="header-bar">
            <h2 style="font-weight: 600;">Client Inventory</h2>
            <div style="display:flex; gap:10px;">
                <input type="text" id="clientSearch" class="search-bar" placeholder="Search Client, IP, BTS..." oninput="filterClients()">
                <button class="btn-import" onclick="document.getElementById('csvInput').click()">
                    <i data-lucide="upload-cloud"></i> Import CSV
                </button>
                <input type="file" id="csvInput" hidden accept=".csv">
            </div>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Client Name</th>
                        <th>IP Address</th>
                        <th>Base Station</th>
                        <th>Location</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="clientTableBody">
                    <tr><td colspan="5" style="text-align:center; padding:40px; color:#666;">Loading Data...</td></tr>
                </tbody>
            </table>
        </div>

    </div>

    <div id="diagPanel" class="slide-panel">
        <div class="panel-header">
            <button onclick="closePanel()" style="float:right; background:none; border:none; color:white; cursor:pointer;"><i data-lucide="x"></i></button>
            <h2 id="p-name">Client Name</h2>
            <div style="font-family:'JetBrains Mono'; color:var(--primary); margin-top:5px;" id="p-ip">--</div>
        </div>
        <div class="panel-body">
            <button class="btn-main" id="btnRun" onclick="runTest()">
                <i data-lucide="play"></i> Run Diagnostics
            </button>

            <div id="resultsArea" style="display:none; margin-top: 30px;">
                <div style="text-align:center; padding: 20px; background:rgba(255,255,255,0.02); border-radius:12px; margin-bottom:20px;">
                    <div id="res-status" style="font-size:2rem; font-weight:800; color:white;">--</div>
                    <div id="res-cause" style="color:#aaa; margin-top:5px;">--</div>
                </div>

                <div class="topology-map">
                    <div class="topology-line"></div>
                    <div class="node" id="n-gw"><i data-lucide="server"></i><span>GW</span></div>
                    <div class="node" id="n-base"><i data-lucide="router"></i><span>BASE</span></div>
                    <div class="node" id="n-client"><i data-lucide="wifi"></i><span>CLIENT</span></div>
                </div>

                <div style="font-size:0.8rem; color:#666; text-transform:uppercase; margin-bottom:10px;">Client Telemetry</div>
                <div class="metric-grid">
                    <div class="metric-box"><div class="metric-lbl">Signal</div><div class="metric-val" id="m-rssi">--</div><div style="font-size:0.7rem; color:#888;" id="m-stab">--</div></div>
                    <div class="metric-box"><div class="metric-lbl">Loss</div><div class="metric-val" id="m-loss">--</div></div>
                    <div class="metric-box"><div class="metric-lbl">Speed</div><div class="metric-val" id="m-lan">--</div></div>
                    <div class="metric-box"><div class="metric-lbl">Latency</div><div class="metric-val" id="m-lat">--</div></div>
                </div>
            </div>
        </div>
    </div>

<script>
    const API_BASE = 'http://192.168.0.104:8000'; // YOUR IP
    let inventory = [];
    let currentClient = null;

    document.addEventListener('DOMContentLoaded', loadData);
    lucide.createIcons();

    // --- IMPORT LOGIC ---
    document.getElementById('csvInput').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async (ev) => {
            const lines = ev.target.result.split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const newData = lines.slice(1).filter(l => l.trim()).map(line => {
                const values = line.split(',');
                const link = {};
                headers.forEach((h, i) => link[h] = values[i] ? values[i].trim().replace(/"/g, '') : '');
                return link;
            });
            
            // Send to Backend
            try {
                await fetch(`${API_BASE}/api/inventory`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(newData)
                });
                alert(`Imported ${newData.length} links!`);
                loadData();
            } catch(e) { alert("Upload Failed"); }
        };
        reader.readAsText(file);
    });

    async function loadData() {
        try {
            const res = await fetch(`${API_BASE}/api/inventory`);
            inventory = await res.json();
            renderClients(inventory);
        } catch(e) { console.error("API Error", e); }
    }

    function renderClients(data) {
        const tbody = document.getElementById('clientTableBody');
        tbody.innerHTML = data.map(c => `
            <tr onclick='openDiag(${JSON.stringify(c)})'>
                <td style="font-weight:600; color:white;">${c.Client_Name}</td>
                <td style="font-family:'JetBrains Mono'; color:#aaa;">${c.Client_IP}</td>
                <td>${c.Base_IP}</td>
                <td>${c.Location}</td>
                <td><span class="tag">Inspect</span></td>
            </tr>
        `).join('');
    }

    function filterClients() {
        const term = document.getElementById('clientSearch').value.toLowerCase();
        renderClients(inventory.filter(c => c.Client_Name.toLowerCase().includes(term) || c.Client_IP.includes(term)));
    }

    function openDiag(client) {
        currentClient = client;
        document.getElementById('p-name').innerText = client.Client_Name;
        document.getElementById('p-ip').innerText = client.Client_IP;
        document.getElementById('resultsArea').style.display = 'none';
        document.getElementById('btnRun').disabled = false;
        document.getElementById('btnRun').innerHTML = `<i data-lucide="play"></i> Run Diagnostics`;
        document.getElementById('diagPanel').classList.add('open');
        lucide.createIcons();
    }

    function closePanel() { document.getElementById('diagPanel').classList.remove('open'); }

    async function runTest() {
        const btn = document.getElementById('btnRun');
        btn.disabled = true;
        btn.innerHTML = `<i data-lucide="loader-2" class="spin"></i> Analyzing...`;
        
        try {
            const res = await fetch(`${API_BASE}/api/diagnose`, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ name: currentClient.Client_Name, ip: currentClient.Client_IP })
            });
            const data = await res.json();
            document.getElementById('resultsArea').style.display = 'block';

            document.getElementById('res-status').innerText = data.final_status;
            document.getElementById('res-status').style.color = data.final_status.includes("UP") ? "var(--success)" : "var(--danger)";
            document.getElementById('res-cause').innerText = data.cause;

            const c = data.topology.client.data;
            document.getElementById('m-rssi').innerText = c.rssi || '--';
            document.getElementById('m-stab').innerText = c.stability || '';
            document.getElementById('m-loss').innerText = data.topology.client.loss;
            document.getElementById('m-lan').innerText = c.lan_speed || '--';
            document.getElementById('m-lat').innerText = data.topology.client.latency || '--';

            setNode('n-client', data.topology.client.status);
            setNode('n-base', data.topology.base.status);
            setNode('n-gw', data.topology.gw.status);

        } catch(e) { alert("Failed"); } 
        finally { btn.innerHTML = `<i data-lucide="check-circle"></i> Done`; lucide.createIcons(); }
    }

    function setNode(id, status) {
        const el = document.getElementById(id);
        el.className = 'node';
        if(status === 'UP') el.classList.add('up');
        else if(status === 'DOWN') el.classList.add('down');
        else el.classList.add('warn');
    }
</script>
</body>
</html>
